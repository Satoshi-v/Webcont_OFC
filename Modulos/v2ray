#!/bin/bash

# Verificar permissões
if [ "$EUID" -ne 0 ]; then
  echo "Por favor, execute como root."
  exit 1
fi

# Variáveis
V2RAY_VERSION="v5.22.0"
ARCH="64"
DOWNLOAD_URL="https://github.com/v2fly/v2ray-core/releases/download/${V2RAY_VERSION}/v2ray-linux-${ARCH}.zip"
TMP_DIR="/tmp/v2ray"
INSTALL_DIR="/usr/bin/v2ray"
CONFIG_DIR="/usr/local/etc/v2ray"
SERVICE_FILE="/etc/systemd/system/v2ray.service"
UUID=$(uuidgen)
PORT=$((RANDOM%40000+1024)) # Porta aleatória entre 1024 e 49151

# Passo 1: Preparar ambiente
echo "Preparando ambiente..."
systemctl stop v2ray.service 2>/dev/null
systemctl disable v2ray.service 2>/dev/null
rm -rf "${INSTALL_DIR}" "${CONFIG_DIR}" "${TMP_DIR}"
rm -f "${SERVICE_FILE}"

# Passo 2: Baixar e instalar V2Ray
echo "Baixando e instalando V2Ray..."
mkdir -p "${TMP_DIR}" "${INSTALL_DIR}" "${CONFIG_DIR}"
wget -O "${TMP_DIR}/v2ray.zip" "${DOWNLOAD_URL}"
unzip -o "${TMP_DIR}/v2ray.zip" -d "${TMP_DIR}"
cp "${TMP_DIR}/v2ray" "${INSTALL_DIR}/"
cp "${TMP_DIR}/v2ctl" "${INSTALL_DIR}/"
chmod +x "${INSTALL_DIR}/v2ray" "${INSTALL_DIR}/v2ctl"

# Passo 3: Configurar serviço no Systemd
echo "Configurando serviço Systemd..."
cat <<EOF > "${SERVICE_FILE}"
[Unit]
Description=V2Ray Service
After=network.target

[Service]
User=nobody
NoNewPrivileges=true
ExecStart=${INSTALL_DIR}/v2ray -config ${CONFIG_DIR}/config.json
Restart=on-failure
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
EOF

# Passo 4: Criar arquivo de configuração
echo "Gerando configuração padrão..."
cat <<EOF > "${CONFIG_DIR}/config.json"
{
  "log": {
    "access": "/var/log/v2ray/access.log",
    "error": "/var/log/v2ray/error.log",
    "loglevel": "warning"
  },
  "inbounds": [{
    "port": ${PORT},
    "protocol": "vmess",
    "settings": {
      "clients": [{
        "id": "${UUID}",
        "alterId": 0
      }]
    },
    "streamSettings": {
      "network": "kcp",
      "kcpSettings": {
        "header": {
          "type": "utp"
        }
      }
    }
  }],
  "outbounds": [{
    "protocol": "freedom",
    "settings": {}
  }]
}
EOF

mkdir -p /var/log/v2ray
touch /var/log/v2ray/access.log /var/log/v2ray/error.log

# Passo 5: Ativar e iniciar o serviço
echo "Ativando e iniciando o serviço V2Ray..."
systemctl daemon-reload
systemctl enable v2ray.service
systemctl start v2ray.service

# Verificar status
if systemctl status v2ray.service | grep -q "active (running)"; then
  echo "V2Ray instalado e em execução com sucesso!"
else
  echo "Erro ao iniciar o serviço V2Ray. Verifique os logs para mais detalhes."
fi

# Exibir informações do servidor
echo "Configuração do servidor:"
echo "IP: $(curl -s ifconfig.me)"
echo "Porta: ${PORT}"
echo "UUID: ${UUID}"
echo "Protocolo: vmess"
echo "Network: kcp"
echo "Header: utp"

VMESS_LINK=$(echo -n "{\"v\":\"2\",\"ps\":\"$(curl -s ifconfig.me):${PORT}\",\"add\":\"$(curl -s ifconfig.me)\",\"port\":\"${PORT}\",\"id\":\"${UUID}\",\"aid\":\"0\",\"net\":\"kcp\",\"type\":\"utp\",\"tls\":\"none\"}" | base64 -w 0)

echo "Link VMess:"
echo "vmess://${VMESS_LINK}"
